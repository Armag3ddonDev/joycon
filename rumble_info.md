*Disclaimer*: Parts of this research is based on [dekuNukems](https://github.com/dekuNukem/Nintendo_Switch_Reverse_Engineering/blob/master/rumble_data_table.md) results. We made the frequency and amplitude data fit in one byte, with increments of `0x01` and proposed a new encoding function for amplitude.

---

# The Rumble Bytes

| Byte 3 | Byte 2 | Byte 1 | Byte 0 |
|:--:|:---:|:---:|:---:|
`01LL LLLL` | `KIII IIII` | `JJJJ JJJG` | `HHHH HH00`

|   ID  | START | STEP | END | Byte
|:------|:-----:|:----:|:---:|:-----------:|
**hf**  | 0x00 |0x01  |0x7F | `0GHH HHHH`
**lf**      | 0x00 |0x01  |0x7F | `0III IIII`
**hf_amp**  | 0x00 |0x01  |0x7F | `0JJJ JJJJ`
**lf_amp**  | 0x00 |0x01  |0x7F | `0LLL LLLK`

Encoding data this way, we get the relations `lf = hf + 0x20` and `lf_amp = hf_amp`, as can be seen in the table.

### Encoding
```
	unsigned char data[4];
	data[0] = (hf << 2);
	data[1] = (hf_amp << 1) | (hf >> 6);
	data[2] = (lf_amp << 7) | lf;
	data[3] = 0x40 | (lf_amp >> 1);
```

### Decoding
```
	hf     = (data[1] << 6) | (data[0] >> 2);
	hf_amp = data[1] >> 1;
	lf     = (unsigned char)(data[2] << 1) >> 1;
	lf_amp = ((unsigned char)(data[3] << 2) >> 1) | (data[2] >> 7);
```

---

# Frequency

## Frequency <- Bytes

The decoding algorithm for frequency is `10.0*pow(2.0, (double)(encoded_hex_freq) / 32.0)`. The result needs to be shifted:

```
	unsigned char encoded_hex_freq = lf + 0x40;
	unsigned char encoded_hex_freq = hf + 0x60;
	
	// maps to 40 - 1252.57223...
	double frequency =  10.0*pow(2.0, (double)(encoded_hex_freq) / 32.0);
	
	// clamp solution
	frequency max(40.87, min(1252.57, frequency));
```

## Frequency -> Bytes

The encoding algorithm for frequency is `log2((double)freq/10.0)*32.0`. Here, the input needs to be shifted.
```
	// frequency must be between 40.87 and 1252.57

	// maps to 0x41(65) - 0xDF(223)
	uint8_t encoded_hex_freq = (uint8_t)(std::round(std::log2(frequency / 10.0)*32.0));

	// Convert to Joy-Con HF range. Range: 0x01-0x7F
	hf = (encoded_hex_freq > 0x60) ? (encoded_hex_freq - 0x60) : 0x00
	// Convert to Joy-Con LF range. Range: 0x01-0x7F.
	lf = (encoded_hex_freq < 0xC0) ? encoded_hex_freq - 0x40 : 0x00;
```

---

# Amplitude

## Amplitude <- Bytes

The decoding algorithm for amplitude is split into four ranges:
*	`0x00`        : `0.0`
*	`0x01 - 0x0F` : `18.0 / 5.0*std::pow(2.0, (double)(hf_amp + 1) / 4.00 - 9.0)`
*	`0x0F - 0x1F` : `18.0 / 5.0*std::pow(2.0, (double)(hf_amp + 1) / 16.0 - 6.0)`
*	`0x1F - 0x7F` : `18.0 / 5.0*std::pow(2.0, (double)(hf_amp + 1) / 32.0 - 5.0)`

This directly yields `hf_amp` and `lf_amp` (without shift), which are equal. If `hf_amp <= 0x64` (safe amplitude range), this function maps to `0.0 - 1.00295`.

## Amplitude -> Bytes

The encoding algorithm for amplitude is split into four ranges:
*	`0.000000 <= amplitude < 0.008000` : `0x00`
*	`0.008000 <= amplitude < 0.112491` : `(uint8_t)(round((log2(amplitude * 5.0 / 18.0) + 9.0)*4.00)) - 1`
*	`0.112491 <= amplitude < 0.224982` : `(uint8_t)(round((log2(amplitude * 5.0 / 18.0) + 6.0)*16.0)) - 1`
*	`1.799701 <= amplitude < 1.799701` : `(uint8_t)(round((log2(amplitude * 5.0 / 18.0) + 5.0)*32.0)) - 1`

Those functions map to `0x00(0) - 0x64(100)` for amplitude <= 1 and `0x00 - 0x7E(126)` for `amplitude < 1.799701`. Remember, that `amplitude > 1` is **NOT** safe for the integrity of the linear resonant actuators!

# Tables

The following tables were copied from [dekuNukems](https://github.com/dekuNukem/Nintendo_Switch_Reverse_Engineering/blob/master/rumble_data_table.md) and adapter for our format of `hf`, `lf`, `hf_amp` and `lf_amp`.

## Frequency Table

| hf | lf | Frequency (Hz) | Frequency Rounded (Hz) |
|:--:|:---:|:---:|:---:|
|	??	|	`01`	|	40.875885	|	41	|
|	??	|	`02`	|	41.77095	|	42	|
|	??	|	`03`	|	42.685616	|	43	|
|	??	|	`04`	|	43.620308	|	44	|
|	??	|	`05`	|	44.57547	|	45	|
|	??	|	`06`	|	45.551544	|	46	|
|	??	|	`07`	|	46.548996	|	47	|
|	??	|	`08`	|	47.568283	|	48	|
|	??	|	`09`	|	48.609894	|	49	|
|	??	|	`0A`	|	49.674313	|	50	|
|	??	|	`0B`	|	50.762039	|	51	|
|	??	|	`0C`	|	51.873581	|	52	|
|	??	|	`0D`	|	53.009464	|	53	|
|	??	|	`0E`	|	54.170223	|	54	|
|	??	|	`0F`	|	55.356396	|	55	|
|	??	|	`10`	|	56.568542	|	57	|
|	??	|	`11`	|	57.807232	|	58	|
|	??	|	`12`	|	59.073048	|	59	|
|	??	|	`13`	|	60.366577	|	60	|
|	??	|	`14`	|	61.688435	|	62	|
|	??	|	`15`	|	63.039234	|	63	|
|	??	|	`16`	|	64.419617	|	64	|
|	??	|	`17`	|	65.830215	|	66	|
|	??	|	`18`	|	67.271713	|	67	|
|	??	|	`19`	|	68.744774	|	69	|
|	??	|	`1A`	|	70.250084	|	70	|
|	??	|	`1B`	|	71.788361	|	72	|
|	??	|	`1C`	|	73.360321	|	73	|
|	??	|	`1D`	|	74.966705	|	75	|
|	??	|	`1E`	|	76.608261	|	77	|
|	??	|	`1F`	|	78.285767	|	78	|
|	??	|	`20`	|	80	|	80	|
|	`01`	|	`21`	|	81.75177	|	82	|
|	`02`	|	`22`	|	83.541901	|	84	|
|	`03`	|	`23`	|	85.371231	|	85	|
|	`04`	|	`24`	|	87.240616	|	87	|
|	`05`	|	`25`	|	89.15094	|	89	|
|	`06`	|	`26`	|	91.103088	|	91	|
|	`07`	|	`27`	|	93.097992	|	93	|
|	`08`	|	`28`	|	95.136566	|	95	|
|	`09`	|	`29`	|	97.219788	|	97	|
|	`0A`	|	`2A`	|	99.348625	|	99	|
|	`0B`	|	`2B`	|	101.524078	|	102	|
|	`0C`	|	`2C`	|	103.747162	|	104	|
|	`0D`	|	`2D`	|	106.018929	|	106	|
|	`0E`	|	`2E`	|	108.340446	|	108	|
|	`0F`	|	`2F`	|	110.712791	|	111	|
|	`10`	|	`30`	|	113.137085	|	113	|
|	`11`	|	`31`	|	115.614464	|	116	|
|	`12`	|	`32`	|	118.146095	|	118	|
|	`13`	|	`33`	|	120.733154	|	121	|
|	`14`	|	`34`	|	123.376869	|	123	|
|	`15`	|	`35`	|	126.078468	|	126	|
|	`16`	|	`36`	|	128.839233	|	129	|
|	`17`	|	`37`	|	131.660431	|	132	|
|	`18`	|	`38`	|	134.543427	|	135	|
|	`19`	|	`39`	|	137.489548	|	137	|
|	`1A`	|	`3A`	|	140.500168	|	141	|
|	`1B`	|	`3B`	|	143.576721	|	144	|
|	`1C`	|	`3C`	|	146.720642	|	147	|
|	`1D`	|	`3D`	|	149.933411	|	150	|
|	`1E`	|	`3E`	|	153.216522	|	153	|
|	`1F`	|	`3F`	|	156.571533	|	157	|
|	`20`	|	`40`	|	160	|	160	|
|	`21`	|	`41`	|	163.50354	|	164	|
|	`22`	|	`42`	|	167.083801	|	167	|
|	`23`	|	`43`	|	170.742462	|	171	|
|	`24`	|	`44`	|	174.481232	|	174	|
|	`25`	|	`45`	|	178.30188	|	178	|
|	`26`	|	`46`	|	182.206177	|	182	|
|	`27`	|	`47`	|	186.195984	|	186	|
|	`28`	|	`48`	|	190.273132	|	190	|
|	`29`	|	`49`	|	194.439575	|	194	|
|	`2A`	|	`4A`	|	198.69725	|	199	|
|	`2B`	|	`4B`	|	203.048157	|	203	|
|	`2C`	|	`4C`	|	207.494324	|	207	|
|	`2D`	|	`4D`	|	212.037857	|	212	|
|	`2E`	|	`4E`	|	216.680893	|	217	|
|	`2F`	|	`4F`	|	221.425583	|	221	|
|	`30`	|	`50`	|	226.27417	|	226	|
|	`31`	|	`51`	|	231.228928	|	231	|
|	`32`	|	`52`	|	236.292191	|	236	|
|	`33`	|	`53`	|	241.466309	|	241	|
|	`34`	|	`54`	|	246.753738	|	247	|
|	`35`	|	`55`	|	252.156937	|	252	|
|	`36`	|	`56`	|	257.678467	|	258	|
|	`37`	|	`57`	|	263.320862	|	263	|
|	`38`	|	`58`	|	269.086853	|	269	|
|	`39`	|	`59`	|	274.979095	|	275	|
|	`3A`	|	`5A`	|	281.000336	|	281	|
|	`3B`	|	`5B`	|	287.153442	|	287	|
|	`3C`	|	`5C`	|	293.441284	|	293	|
|	`3D`	|	`5D`	|	299.866821	|	300	|
|	`3E`	|	`5E`	|	306.433044	|	306	|
|	`3F`	|	`5F`	|	313.143066	|	313	|
|	`40`	|	`60`	|	320	|	320	|
|	`41`	|	`61`	|	327.00708	|	327	|
|	`42`	|	`62`	|	334.167603	|	334	|
|	`43`	|	`63`	|	341.484924	|	341	|
|	`44`	|	`64`	|	348.962463	|	349	|
|	`45`	|	`65`	|	356.60376	|	357	|
|	`46`	|	`66`	|	364.412354	|	364	|
|	`47`	|	`67`	|	372.391968	|	372	|
|	`48`	|	`68`	|	380.546265	|	381	|
|	`49`	|	`69`	|	388.87915	|	389	|
|	`4A`	|	`6A`	|	397.394501	|	397	|
|	`4B`	|	`6B`	|	406.096313	|	406	|
|	`4C`	|	`6C`	|	414.988647	|	415	|
|	`4D`	|	`6D`	|	424.075714	|	424	|
|	`4E`	|	`6E`	|	433.361786	|	433	|
|	`4F`	|	`6F`	|	442.851166	|	443	|
|	`50`	|	`70`	|	452.54834	|	453	|
|	`51`	|	`71`	|	462.457855	|	462	|
|	`52`	|	`72`	|	472.584381	|	473	|
|	`53`	|	`73`	|	482.932617	|	483	|
|	`54`	|	`74`	|	493.507477	|	494	|
|	`55`	|	`75`	|	504.313873	|	504	|
|	`56`	|	`76`	|	515.356934	|	515	|
|	`57`	|	`77`	|	526.641724	|	527	|
|	`58`	|	`78`	|	538.173706	|	538	|
|	`59`	|	`79`	|	549.958191	|	550	|
|	`5A`	|	`7A`	|	562.000671	|	562	|
|	`5B`	|	`7B`	|	574.306885	|	574	|
|	`5C`	|	`7C`	|	586.882568	|	587	|
|	`5D`	|	`7D`	|	599.733643	|	600	|
|	`5E`	|	`7E`	|	612.866089	|	613	|
|	`5F`	|	`7F`	|	626.286133	|	626	|
|	`60`	|	??	|	640	|	640	|
|	`61`	|	??	|	654.01416	|	654	|
|	`62`	|	??	|	668.335205	|	668	|
|	`63`	|	??	|	682.969849	|	683	|
|	`64`	|	??	|	697.924927	|	698	|
|	`65`	|	??	|	713.20752	|	713	|
|	`66`	|	??	|	728.824707	|	729	|
|	`67`	|	??	|	744.783936	|	745	|
|	`68`	|	??	|	761.092529	|	761	|
|	`69`	|	??	|	777.758301	|	778	|
|	`6A`	|	??	|	794.789001	|	795	|
|	`6B`	|	??	|	812.192627	|	812	|
|	`6C`	|	??	|	829.977295	|	830	|
|	`6D`	|	??	|	848.151428	|	848	|
|	`6E`	|	??	|	866.723572	|	867	|
|	`6F`	|	??	|	885.702332	|	886	|
|	`70`	|	??	|	905.09668	|	905	|
|	`71`	|	??	|	924.91571	|	925	|
|	`72`	|	??	|	945.168762	|	945	|
|	`73`	|	??	|	965.865234	|	966	|
|	`74`	|	??	|	987.014954	|	987	|
|	`75`	|	??	|	1008.627747	|	1009	|
|	`76`	|	??	|	1030.713867	|	1031	|
|	`77`	|	??	|	1053.283447	|	1053	|
|	`78`	|	??	|	1076.347412	|	1076	|
|	`79`	|	??	|	1099.916382	|	1100	|
|	`7A`	|	??	|	1124.001343	|	1124	|
|	`7B`	|	??	|	1148.61377	|	1149	|
|	`7C`	|	??	|	1173.765137	|	1174	|
|	`7D`	|	??	|	1199.467285	|	1199	|
|	`7E`	|	??	|	1225.732178	|	1226	|
|	`7F`	|	??	|	1252.572266	|	1253	|



## Amplitude Table


| hf_amp | lf_amp | Amplitude | Amplitude Rounded |
|:--:|:---:|:---:|:---:|
|	`00`	|	`00`	|	0.000000	|	0.000	|
|	`01`	|	`01`	|	0.007843	|	0.010	|
|	`02`	|	`02`	|	0.011823	|	0.012	|
|	`03`	|	`03`	|	0.014061	|	0.014	|
|	`04`	|	`04`	|	0.016720	|	0.017	|
|	`05`	|	`05`	|	0.019885	|	0.020	|
|	`06`	|	`06`	|	0.023648	|	0.024	|
|	`07`	|	`07`	|	0.028123	|	0.028	|
|	`08`	|	`08`	|	0.033442	|	0.033	|
|	`09`	|	`09`	|	0.039771	|	0.040	|
|	`0A`	|	`0A`	|	0.047296	|	0.047	|
|	`0B`	|	`0B`	|	0.056246	|	0.056	|
|	`0C`	|	`0C`	|	0.066886	|	0.067	|
|	`0D`	|	`0D`	|	0.079542	|	0.080	|
|	`0E`	|	`0E`	|	0.094592	|	0.095	|
|	`0F`	|	`0F`	|	0.112491	|	0.112	|
|	`10`	|	`10`	|	0.117471	|	0.117	|
|	`11`	|	`11`	|	0.122671	|	0.123	|
|	`12`	|	`12`	|	0.128102	|	0.128	|
|	`13`	|	`13`	|	0.133774	|	0.134	|
|	`14`	|	`14`	|	0.139697	|	0.140	|
|	`15`	|	`15`	|	0.145882	|	0.146	|
|	`16`	|	`16`	|	0.152341	|	0.152	|
|	`17`	|	`17`	|	0.159085	|	0.159	|
|	`18`	|	`18`	|	0.166129	|	0.166	|
|	`19`	|	`19`	|	0.173484	|	0.173	|
|	`1A`	|	`1A`	|	0.181166	|	0.181	|
|	`1B`	|	`1B`	|	0.189185	|	0.189	|
|	`1C`	|	`1C`	|	0.197561	|	0.198	|
|	`1D`	|	`1D`	|	0.206308	|	0.206	|
|	`1E`	|	`1E`	|	0.215442	|	0.215	|
|	`1F`	|	`1F`	|	0.224982	|	0.225	|
|	`20`	|	`20`	|	0.229908	|	0.230	|
|	`21`	|	`21`	|	0.234943	|	0.235	|
|	`22`	|	`22`	|	0.240087	|	0.240	|
|	`23`	|	`23`	|	0.245345	|	0.245	|
|	`24`	|	`24`	|	0.250715	|	0.251	|
|	`25`	|	`25`	|	0.256206	|	0.256	|
|	`26`	|	`26`	|	0.261816	|	0.262	|
|	`27`	|	`27`	|	0.267549	|	0.268	|
|	`28`	|	`28`	|	0.273407	|	0.273	|
|	`29`	|	`29`	|	0.279394	|	0.279	|
|	`2A`	|	`2A`	|	0.285514	|	0.286	|
|	`2B`	|	`2B`	|	0.291765	|	0.292	|
|	`2C`	|	`2C`	|	0.298154	|	0.298	|
|	`2D`	|	`2D`	|	0.304681	|	0.305	|
|	`2E`	|	`2E`	|	0.311353	|	0.311	|
|	`2F`	|	`2F`	|	0.318171	|	0.318	|
|	`30`	|	`30`	|	0.325138	|	0.325	|
|	`31`	|	`31`	|	0.332258	|	0.332	|
|	`32`	|	`32`	|	0.339534	|	0.340	|
|	`33`	|	`33`	|	0.346969	|	0.347	|
|	`34`	|	`34`	|	0.354566	|	0.355	|
|	`35`	|	`35`	|	0.362331	|	0.362	|
|	`36`	|	`36`	|	0.370265	|	0.370	|
|	`37`	|	`37`	|	0.378372	|	0.378	|
|	`38`	|	`38`	|	0.386657	|	0.387	|
|	`39`	|	`39`	|	0.395124	|	0.395	|
|	`3A`	|	`3A`	|	0.403777	|	0.404	|
|	`3B`	|	`3B`	|	0.412619	|	0.413	|
|	`3C`	|	`3C`	|	0.421652	|	0.422	|
|	`3D`	|	`3D`	|	0.430885	|	0.431	|
|	`3E`	|	`3E`	|	0.440321	|	0.440	|
|	`3F`	|	`3F`	|	0.449964	|	0.450	|
|	`40`	|	`40`	|	0.459817	|	0.460	|
|	`41`	|	`41`	|	0.469885	|	0.470	|
|	`42`	|	`42`	|	0.480174	|	0.480	|
|	`43`	|	`43`	|	0.490689	|	0.491	|
|	`44`	|	`44`	|	0.501433	|	0.501	|
|	`45`	|	`45`	|	0.512413	|	0.512	|
|	`46`	|	`46`	|	0.523633	|	0.524	|
|	`47`	|	`47`	|	0.535100	|	0.535	|
|	`48`	|	`48`	|	0.546816	|	0.547	|
|	`49`	|	`49`	|	0.558790	|	0.559	|
|	`4A`	|	`4A`	|	0.571027	|	0.571	|
|	`4B`	|	`4B`	|	0.583530	|	0.584	|
|	`4C`	|	`4C`	|	0.596307	|	0.596	|
|	`4D`	|	`4D`	|	0.609365	|	0.609	|
|	`4E`	|	`4E`	|	0.622708	|	0.623	|
|	`4F`	|	`4F`	|	0.636344	|	0.636	|
|	`50`	|	`50`	|	0.650279	|	0.650	|
|	`51`	|	`51`	|	0.664518	|	0.665	|
|	`52`	|	`52`	|	0.679069	|	0.679	|
|	`53`	|	`53`	|	0.693939	|	0.694	|
|	`54`	|	`54`	|	0.709133	|	0.709	|
|	`55`	|	`55`	|	0.724662	|	0.725	|
|	`56`	|	`56`	|	0.740529	|	0.741	|
|	`57`	|	`57`	|	0.756745	|	0.757	|
|	`58`	|	`58`	|	0.773316	|	0.773	|
|	`59`	|	`59`	|	0.790249	|	0.790	|
|	`5A`	|	`5A`	|	0.807554	|	0.808	|
|	`5B`	|	`5B`	|	0.825237	|	0.825	|
|	`5C`	|	`5C`	|	0.843307	|	0.843	|
|	`5D`	|	`5D`	|	0.861772	|	0.862	|
|	`5E`	|	`5E`	|	0.880643	|	0.881	|
|	`5F`	|	`5F`	|	0.899928	|	0.900	|
|	`60`	|	`60`	|	0.919633	|	0.920	|
|	`61`	|	`61`	|	0.939771	|	0.940	|
|	`62`	|	`62`	|	0.960348	|	0.960	|
|	`63`	|	`63`	|	0.981378	|	0.981	|
|	`64`	|	`64`	|	1.002867	|	1.003	|

The amplitudes below are not safe for the integrity of the linear resonant actuators.

| hf_amp | lf_amp | Amplitude | Amplitude Rounded |
|:--:|:---:|:---:|:---:|
|	`65`	|	`65`	|	1.024826	|	1.025	|
|	`66`	|	`66`	|	1.047266	|	1.047	|
|	`67`	|	`67`	|	1.070197	|	1.070	|
|	`68`	|	`68`	|	1.093630	|	1.094	|
|	`69`	|	`69`	|	1.117576	|	1.118	|
|	`6A`	|	`6A`	|	1.142045	|	1.142	|
|	`6B`	|	`6B`	|	1.167051	|	1.167	|
|	`6C`	|	`6C`	|	1.192603	|	1.193	|
|	`6D`	|	`6D`	|	1.218715	|	1.219	|
|	`6E`	|	`6E`	|	1.245398	|	1.245	|
|	`6F`	|	`6F`	|	1.272665	|	1.273	|
|	`70`	|	`70`	|	1.300529	|	1.301	|
|	`71`	|	`71`	|	1.329003	|	1.329	|
|	`72`	|	`72`	|	1.358100	|	1.358	|
|	`73`	|	`73`	|	1.387834	|	1.388	|
|	`74`	|	`74`	|	1.418218	|	1.418	|
|	`75`	|	`75`	|	1.449268	|	1.449	|
|	`76`	|	`76`	|	1.480997	|	1.481	|
|	`77`	|	`77`	|	1.513420	|	1.513	|
|	`78`	|	`78`	|	1.546553	|	1.547	|
|	`79`	|	`79`	|	1.580411	|	1.580	|
|	`7A`	|	`7A`	|	1.615010	|	1.615	|
|	`7B`	|	`7B`	|	1.650366	|	1.650	|
|	`7C`	|	`7C`	|	1.686497	|	1.686	|
|	`7D`	|	`7D`	|	1.723417	|	1.723	|
|	`7E`	|	`7E`	|	1.761146	|	1.761	|
|	`7F`	|	`7F`	|	1.799701	|	1.800	|


